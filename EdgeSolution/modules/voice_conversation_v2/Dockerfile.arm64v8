# Use base image (pre-built) - version controlled by Pipeline
ARG BASE_VERSION
FROM pokepalregistry.azurecr.io/voice-conversation-base:${BASE_VERSION}

# Set working directory
WORKDIR /app

# Copy requirements.txt first for better layer caching
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code (maintain directory structure) - after dependencies
COPY main.py ./

# Copy each layer directory
COPY domain ./domain
COPY application ./application
COPY adapters ./adapters
COPY infrastructure ./infrastructure

# Create directory for memory files
RUN mkdir -p /app/memories

# Set PYTHONPATH
ENV PYTHONPATH=/app

# Environment variables can be configured as needed during deployment

# Entry point
CMD ["python", "-u", "main.py"]