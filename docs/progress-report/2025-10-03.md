# Pokepalプロジェクト 進捗状況

最終更新日: 2025/10/03
作成者: 對馬

---

## 1. プロジェクト概要

**プロジェクト名:** Pokepal

**概要:**
Pokepalは、介護施設向けに開発された音声ベースの対話型コンパニオンシステムである。Raspberry Pi等のエッジデバイス上で稼働し、Azure IoT Hubおよび関連Azureサービスを活用して、入居者との自然な会話を実現しつつ施設スタッフの負担軽減を図る。
施設スタッフが管理画面から個別の服薬時間や食事時間などを設定でき、各入居者に合わせたパーソナライズされた音声通知・リマインダーを提供する。
機能面では、Azure IoT Hubを通じた自動更新・自動デプロイにより、常に最新の機能が利用可能となる。

---

## 2. プロジェクト目的

- **対話機能の実現:**
  ユーザーの音声入力をキャプチャし、テキスト化。AIによる応答生成と音声合成（TTS）で自然な対話を構築する。会話履歴を記憶し、会話の文脈に応じて適切に活用する。

- **個別ケアの支援:**
  施設スタッフが管理画面から入居者ごとの服薬時間、食事時間、その他のリマインド事項を設定可能。各入居者の生活リズムに合わせたパーソナライズされた音声通知を実現し、介護スタッフの業務負担を軽減。

- **クラウド連携:**
  Azure IoT Hubを中心に、エッジデバイスとクラウドサービス間でデータを送受信。会話ログや音声ファイルはCosmos DBおよびBlob Storageに保存。設定情報はModule Twin経由で各デバイスに自動配信。

- **自動更新・運用管理:**
  開発チームが作成したコードをAzure DevOps経由で自動ビルド・デプロイ。施設側での複雑な操作は不要で、常に最新の機能を利用可能。

---

## 3. システム構成およびアーキテクチャ

### 3.1 エッジデバイス（Raspberry Pi）

- **OS:** Debian BookwormベースのRaspberry Pi OS (64-bit)
- **IoT Edge Runtime:** aziot-edge 1.5（インストール済み、Azure IoT Hubとの接続確立済み）
- **ハードウェア:**
  - Raspberry Pi 5 (8GB RAM)
  - USB マイク（USB PnP Sound Device）
  - USB スピーカー（USB Audio Device）
  - （将来的拡張）カメラモジュール、バッテリー（ポータブル用）、Jetson Orin Nano

### 3.2 クラウド側（Azure）

- **IoT Hub:** デバイス管理とモジュールデプロイ（pokepalhub-s1）
- **ストレージ:**
  - Cosmos DB：構造化ログ・会話履歴保存、デバイスステータス管理
  - Blob Storage：音声ファイル・メモリファイル等の非構造化データ保存
- **AIサービス:** OpenAI API（GPT-4o-mini、Whisper API）、Azure Speech Services（TTS）
- **CI/CD:** Azure DevOps Pipeline（構築済み、自動ビルド・デプロイ実装済み）
- **コンテナレジストリ:** Azure Container Registry（pokepalregistry、設定済み、認証設定完了）
- **セキュリティ:** Azure Key Vault（APIキー管理、証明書認証）

### 3.3 ソフトウェアコンポーネント

- **IoT Edge Runtime (aziot-edge):** エッジモジュール管理用ランタイム
- **実装済みモジュール:**
  - **Voice Conversation Module v2:** 統合音声対話モジュール（v0.1.77）
    - VAD（Voice Activity Detection）による音声検出（閾値0.9、誤検知防止）
    - OpenAI Whisper APIによる音声認識（平均1.6～3.2秒、ウォームアップ済み）
    - GPT-4o-mini による対話応答生成（コンテキスト5メッセージ最適化）
    - Azure Speech Services（ja-JP-NanamiNeural）による音声合成
    - 4段階メモリシステム（即時・短期・中期・長期記憶）
    - ProactiveService（ConfigLoader統合、{user_name}プレースホルダー対応）
    - Module Twinによる動的設定管理（30以上の設定項目）
    - 非同期処理最適化（テレメトリ送信、LLM処理）
    - Clean Architecture実装完了
    - USBスピーカーへの音声出力最適化（9/24実装）
  - **System Monitor Module:** システム監視・ディスク管理
- **Azure Functions（Python）:**
  - **ConversationLogger:** 会話ログのCosmos DB保存
  - **MemoryGenerator:** 毎時メモリ生成処理（過去メモリ統合機能）
  - **DeviceStatusAPI:** デバイスステータスAPI（管理画面連携、9/30新規実装）
- **管理画面（Vue.js）:**
  - **Admin Dashboard:** デバイスステータス監視画面（Phase 1完了、10/2）
    - Vue 3（Composition API）+ Vite
    - Pinia（状態管理）
    - axios（HTTPクライアント）
    - リアルタイムデバイス状態表示
    - エラーハンドリング・再試行機能

---

## 4. 機能要件と性能

### 4.1 入力
- USBマイクによる音声キャプチャ（自動デバイス検出機能付き）
- IoT Hubダイレクトメソッドによるコマンド実行
- Module Twinによる設定変更

### 4.2 処理とストリーミング実装
- **VAD（Voice Activity Detection）**
  - リアルタイム音声検出（閾値0.9、誤検知防止）
  - フレーム長30ms、最小発話時間1.5秒
- **STT（Speech-to-Text）**
  - OpenAI Whisper API（非ストリーミング、1.6～3.2秒）
  - ウォームアップ実装：起動時にAPI接続事前確立
  - /dev/shm使用でファイルI/O高速化
- **LLM（Large Language Model）**
  - GPT-4o-mini（ストリーミング対応、stream=True）
  - TTFT: 0.7～1.2秒（2回目以降）、初回5.9秒
  - 24文字バッファリングでTTSに逐次送信
  - コンテキスト最適化：10→5メッセージ
- **TTS（Text-to-Speech）**
  - Azure Speech Services（疑似ストリーミング）
  - FirstByte: 200～400ms
  - 24文字セグメントごとに個別合成・即座再生
  - USBスピーカーへの出力最適化（9/24実装）
- **メモリシステム**
  - 4段階記憶（即時・短期・中期・長期）
  - 起動時プリロードでディスクI/O削減

### 4.3 出力
- USBスピーカーによる音声再生（HDMI出力からUSB出力に変更）
- IoT Hubテレメトリによる会話ログ送信（非同期）
- Azure Functionsを介したCosmos DBへの永続化
- デバイスステータスのリアルタイム送信（管理画面連携）

### 4.4 能動的な会話促進
- ProactiveService：毎時食べ物アナウンス（テスト用）
- ConfigLoader統合による永続的タスク管理
- LLM統合メッセージ生成（{user_name}動的置換）

### 4.5 パフォーマンス指標
| 測定項目 | 最適化前 | 最適化後 |
|---------|---------|---------|
| 全体応答時間 | 10秒以上 | **2.6～4.9秒** |
| STT処理時間 | 6秒（初期化含む） | **1.6～3.2秒** |
| TTFT（初回） | - | 5.9秒 |
| TTFT（2回目以降） | - | **0.7～1.2秒** |
| TTS FirstByte | - | **200～400ms** |
| コンテナ安定性 | 30秒ごと再起動 | **安定稼働** |

---

## 5. 技術的な成果

### 5.1 管理画面Phase 1実装

#### 概要
施設スタッフ向けのWebベース管理画面の初期実装を完了。複数デバイスの稼働状態を一元管理できるシステムを構築。

#### バックエンド実装（DeviceStatusAPI）
- **技術:** Azure Functions HTTP Trigger（Python 3.11）
- **エンドポイント:** `GET /api/devices`
- **データソース:** Cosmos DB（devicesコンテナ）
- **機能:**
  - デバイス一覧取得
  - 最終ハートビート時刻管理
  - オフライン検出（5分以上無応答）
  - CORS設定（ローカル開発環境対応）
  - 構造化ログ出力

**データモデル:**
```json
{
  "deviceId": "PokepalDevice1",
  "lastHeartbeat": "2025-10-02T10:30:00Z",
  "isOnline": true,
  "status": "running"
}
```

#### フロントエンド実装（Vue.js）
- **技術スタック:**
  - Vue 3（Composition API、`<script setup>`）
  - Vite（ビルドツール）
  - Pinia（状態管理）
  - axios（HTTPクライアント）

- **実装ファイル:**
  - `src/api/client.js`: axios設定（10秒タイムアウト、インターセプター）
  - `src/api/devices.js`: デバイスAPI関数
  - `src/stores/devices.js`: Piniaストア（状態管理）
  - `src/utils/formatters.js`: 表示用フォーマット関数
  - `src/main.js`: Pinia登録
  - `src/App.vue`: メインコンポーネント

- **機能:**
  - デバイス一覧表示
  - デバイス名フォーマット（例: "Device #1 (RaspberryPi)"）
  - 相対時刻表示（例: "5分前"）
  - ステータス表示（🟢 オンライン / 🔴 オフライン）
  - エラーバウンダリ実装
  - ローディング状態管理
  - エラー時の再試行機能

#### 品質基準（P0準拠）
- ✅ 10秒HTTPタイムアウト
- ✅ AbortControllerによるリクエストキャンセル
- ✅ PII非ログ対応（response.dataをログに含めない）
- ✅ エラー分類（NotFound, ServiceUnavailable, Timeout）
- ✅ HTTPメトリクス記録（レイテンシ測定）
- ✅ Vueコンポーネントでのエラーバウンダリ
- ✅ 再試行導線

#### テスト結果
- ローカル環境（`npm run dev`）で動作確認完了
- デバイス2台の状態を正常に表示（両デバイスともオフライン状態を正しく検出）
- CORS設定動作確認完了

### 5.2 音声出力デバイス最適化

#### 問題
音声再生がHDMI出力に送られ、USB スピーカーから音が出ない問題が発生。

#### 解決策
- `audio_devices.py`を修正し、USB スピーカーをデフォルト出力に指定
- 音声デバイス選択ロジックの変更

#### 効果
- ヘッドレス運用での音声出力の信頼性向上
- HDMI接続ディスプレイへの依存排除
- 介護施設での実運用環境に最適化

### 5.3 UTC タイムスタンプ処理修正

#### 問題
`formatRelativeTime`関数でUTCタイムスタンプの処理が正しく行われず、相対時刻表示が不正確。

#### 解決策
- ISO 8601 UTC形式のタイムスタンプパース処理を修正
- タイムゾーン変換の正確性を確保

#### 効果
- 管理画面での「X分前」表示が正確に動作

---

## 6. 現在の課題と今後の予定

### 6.1 技術的課題と制約

#### 現在の課題
- **初回レスポンス遅延:** TTFT 5.9秒（ウォームアップ済みなのに遅い）
- **音声セグメント継続性:** 24文字ごとの個別再生で途切れる
- **Module Twin Phase2:** クラウドからの動的設定更新未実装

#### 技術的制約
- **STTストリーミング不可:** Whisper APIが非ストリーミング仕様
- **TTSセグメント問題:** Azure Speech APIの制約で連続再生困難
- **リソース制限:** Raspberry Pi 5のCPU/メモリ制約

#### 改善案
- **真のストリーミングSTT:** Azure Speech Services STTまたはWhisper.cppへの移行
- **音声バッファリング:** PyAudioやALSA直接制御で連続再生実現
- **初回改善:** DNS事前解決、より積極的なプリフェッチ

### 6.2 次期開発予定

#### 管理画面Phase 2-5
1. **Phase 2: 利用者管理機能**
   - 利用者一覧表示
   - 利用者情報追加・編集・削除
   - UserAPI実装（Azure Functions）
   - Cosmos DB usersコンテナ作成

2. **Phase 3: スケジュール管理**
   - 週間スケジュール編集UI
   - プロアクティブタスク設定
   - ※注意：voice-conversationモジュール側のスケジュール受信機能は未実装のため、画面のみの実装となる見込み

3. **Phase 4: Module Twin統合**
   - リアルタイムデバイス設定更新
   - IoT Hubダイレクトメソッド呼び出し
   - リモート再起動・制御機能

4. **Phase 5: 認証・本番デプロイ**
   - Azure AD B2C統合
   - ロールベースアクセス制御
   - Azure Static Web Appsへのデプロイ

#### インフラ改善
- Trivyセキュリティスキャン再有効化（現在無効化中）
- IoT Edge Runtimeアップグレード（1.4 → 1.5）
- Key Vault証明書認証セットアップ完了

---

## 7. デプロイ履歴（直近）

| バージョン | 日付 | 主な変更内容 |
|-----------|------|------------|
| v0.1.77 | 10/2 | UTC タイムスタンプ処理修正 |
| v0.1.76 | 9/24 | USB スピーカー出力対応 |
| - | 9/30 | DeviceStatusAPI デプロイ |
| - | 10/2 | 管理画面Phase 1完了 |

---

## 8. プロジェクト管理情報

- **GitHub リポジトリ:**
  - メイン: PokePalPoc（プライベート）
  - 公開用: Pokepal-public（ドキュメント共有用）
- **Azure DevOps:** 自動ビルド・デプロイパイプライン稼働中
- **開発環境:** MacBook Pro + VS Code + Claude Code
- **テスト環境:** Raspberry Pi 5、NVIDIA Jetson Orin Nano

---

## 9. まとめ

2025年9月から10月初旬にかけて、Pokepalプロジェクトは管理画面開発という新たなフェーズに突入した。

### 主な成果
1. **管理画面Phase 1完了:** Vue.js + Azure Functionsによるデバイス状態監視システムの実装
2. **音声出力最適化:** USB スピーカーへの出力切り替えによる実運用環境対応
3. **品質基準の確立:** P0レベルのエラーハンドリング・HTTPクライアント実装

### 技術的学習
- Vue.js フロントエンド開発（リアクティビティ、Pinia、Composition API）
- axios インターセプターによるHTTPメトリクス記録
- AbortControllerによる並行制御
- JavaScript Promiseとasync/awaitパターン

### 今後の展望
管理画面のPhase 2以降の実装を進め、利用者管理・スケジュール管理機能を追加予定。施設スタッフが直感的に操作できるUIを目指し、実運用に向けた準備を進める。
