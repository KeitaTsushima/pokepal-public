# Pokepalプロジェクト 進捗状況

最終更新日: 2025/08/27
作成者: 對馬

---

## 1. プロジェクト概要

**プロジェクト名:** Pokepal

**概要:**  
Pokepalは、介護施設向けに開発された音声ベースの対話型コンパニオンシステムである。Raspberry Pi等のエッジデバイス上で稼働し、Azure IoT Hubおよび関連Azureサービスを活用して、入居者との自然な会話を実現しつつ施設スタッフの負担軽減を図る。
施設スタッフが管理画面から個別の服薬時間や食事時間などを設定でき、各入居者に合わせたパーソナライズされた音声通知・リマインダーを提供する。
機能面では、Azure IoT Hubを通じた自動更新・自動デプロイにより、常に最新の機能が利用可能となる。

---

## 2. プロジェクト目的

- **対話機能の実現:**  
  ユーザーの音声入力をキャプチャし、テキスト化。AIによる応答生成と音声合成（TTS）で自然な対話を構築する。会話履歴を記憶し、会話の文脈に応じて適切に活用する。

- **個別ケアの支援:**  
  施設スタッフが管理画面から入居者ごとの服薬時間、食事時間、その他のリマインド事項を設定可能。各入居者の生活リズムに合わせたパーソナライズされた音声通知を実現し、介護スタッフの業務負担を軽減。

- **クラウド連携:**  
  Azure IoT Hubを中心に、エッジデバイスとクラウドサービス間でデータを送受信。会話ログや音声ファイルはCosmos DBおよびBlob Storageに保存。設定情報はModule Twin経由で各デバイスに自動配信。

- **自動更新・運用管理:**  
  開発チームが作成したコードをAzure DevOps経由で自動ビルド・デプロイ。施設側での複雑な操作は不要で、常に最新の機能を利用可能。

---

## 3. システム構成およびアーキテクチャ

### 3.1 エッジデバイス（Raspberry Pi）

- **OS:** Debian BookwormベースのRaspberry Pi OS (64-bit)
- **IoT Edge Runtime:** aziot-edge 1.5（インストール済み、Azure IoT Hubとの接続確立済み）
- **ハードウェア:**
  - Raspberry Pi 5 (8GB RAM)
  - USB マイク（USB PnP Sound Device）
  - USB スピーカー（USB Audio Device）
  - （将来的拡張）カメラモジュール、バッテリー（ポータブル用）、Jetson Orin Nano

### 3.2 クラウド側（Azure）

- **IoT Hub:** デバイス管理とモジュールデプロイ（pokepalhub-s1）
- **ストレージ:**
  - Cosmos DB：構造化ログ・会話履歴保存（セキュア管理を徹底し、プライバシー保護を確保）
  - Blob Storage：音声ファイル・メモリファイル等の非構造化データ保存
- **AIサービス:** OpenAI API（GPT-4o-mini、Whisper API）、Azure Speech Services（TTS）
- **CI/CD:** Azure DevOps Pipeline（構築済み、自動ビルド・デプロイ実装済み）
- **コンテナレジストリ:** Azure Container Registry（pokepalregistry、設定済み、認証設定完了）
- **セキュリティ:** Azure Key Vault（APIキー管理、証明書認証）

### 3.3 ソフトウェアコンポーネント

- **IoT Edge Runtime (aziot-edge):** エッジモジュール管理用ランタイム
- **実装済みモジュール:**
  - **Voice Conversation Module v2:** 統合音声対話モジュール（v0.1.76）
    - VAD（Voice Activity Detection）による音声検出（閾値0.9、誤検知防止）
    - OpenAI Whisper APIによる音声認識（平均1.6～3.2秒、ウォームアップ済み）
    - GPT-4o-mini による対話応答生成（コンテキスト5メッセージ最適化）
    - Azure Speech Services（ja-JP-NanamiNeural）による音声合成
    - 4段階メモリシステム（即時・短期・中期・長期記憶）
    - ProactiveService（ConfigLoader統合、{user_name}プレースホルダー対応）
    - Module Twinによる動的設定管理（30以上の設定項目）
    - 非同期処理最適化（テレメトリ送信、LLM処理）
    - Clean Architecture実装完了
  - **System Monitor Module:** システム監視・ディスク管理
- **Azure Functions（Python、英語化完了）:**
  - **ConversationLogger:** 会話ログのCosmos DB保存
  - **MemoryGenerator:** 毎時メモリ生成処理（過去メモリ統合機能）

---

## 4. 機能要件と性能

### 4.1 入力
- USBマイクによる音声キャプチャ（自動デバイス検出機能付き）
- IoT Hubダイレクトメソッドによるコマンド実行
- Module Twinによる設定変更

### 4.2 処理とストリーミング実装
- **VAD（Voice Activity Detection）**
  - リアルタイム音声検出（閾値0.9、誤検知防止）
  - フレーム長30ms、最小発話時間1.5秒
- **STT（Speech-to-Text）**
  - OpenAI Whisper API（非ストリーミング、1.6～3.2秒）
  - ウォームアップ実装：起動時にAPI接続事前確立
  - /dev/shm使用でファイルI/O高速化
- **LLM（Large Language Model）**
  - GPT-4o-mini（ストリーミング対応、stream=True）
  - TTFT: 0.7～1.2秒（2回目以降）、初回5.9秒
  - 24文字バッファリングでTTSに逐次送信
  - コンテキスト最適化：10→5メッセージ
- **TTS（Text-to-Speech）**
  - Azure Speech Services（疑似ストリーミング）
  - FirstByte: 200～400ms
  - 24文字セグメントごとに個別合成・即座再生
  - 課題：セグメント間で音声が途切れる
- **メモリシステム**
  - 4段階記憶（即時・短期・中期・長期）
  - 起動時プリロードでディスクI/O削減

### 4.3 出力
- USBスピーカーによる音声再生
- IoT Hubテレメトリによる会話ログ送信（非同期）
- Azure Functionsを介したCosmos DBへの永続化

### 4.4 能動的な会話促進
- ProactiveService：毎時食べ物アナウンス（テスト用）
- ConfigLoader統合による永続的タスク管理
- LLM統合メッセージ生成（{user_name}動的置換）

### 4.5 パフォーマンス指標
| 測定項目 | 最適化前 | 最適化後 |
|---------|---------|---------|
| 全体応答時間 | 10秒以上 | **2.6～4.9秒** |
| STT処理時間 | 6秒（初期化含む） | **1.6～3.2秒** |
| TTFT（初回） | - | 5.9秒 |
| TTFT（2回目以降） | - | **0.7～1.2秒** |
| TTS FirstByte | - | **200～400ms** |
| コンテナ安定性 | 30秒ごと再起動 | **安定稼働** |

---

## 5. 技術的な成果（2025/08/25～27）

### 5.1 パフォーマンス最適化の詳細

#### ウォームアップ実装
- **STTウォームアップ:** 起動時にWhisper API接続確立、HTTPクライアント初期化、Key Vault認証
  - 効果：初回STT処理6秒→1.6秒
- **LLMウォームアップ:** SharedAsyncOpenAIシングルトン事前初期化、OpenAIクライアントキャッシュ
  - 効果：初回LLM呼び出しの遅延削減
- **TTSウォームアップ:** Azure Speech接続事前確立、短いテストメッセージで初期化
  - 効果：FirstByte latency安定化（200-400ms）
- **メモリプリロード:** 当日メモリファイルを起動時にメモリへ読み込み
  - 効果：初回会話時のディスクI/O削減

#### キャッシング戦略
- **OpenAIクライアント:** シングルトンパターンでsecret_name別にキャッシュ
- **APIキー:** Key Vaultから取得後メモリ保持（2-3秒削減）
- **認証トークン:** Azure AD証明書認証トークンの再利用
- **メモリファイル:** 当日分をメモリに保持、会話ごとのI/O削減

#### 非同期処理最適化
- **テレメトリ送信:** Fire-and-forget非同期送信でTTFT 4秒削減
- **並列処理:** STT中のLLMコンテキスト準備、TTS処理と音声再生の並列実行
- **メモリ保存:** 別スレッドで非同期実行

#### その他の最適化
- **VAD最適化:** 検出閾値0.7→0.9で誤検知防止
- **音声フォーマット:** 16kHz/16bit/モノラル、ffmpeg最適化
- **RAMディスク活用:** /dev/shm使用でファイルI/O高速化
- **コンテナ安定性:** memory_updateのNullエラー対処で30秒ごとの再起動解消

### 5.2 プロアクティブ機能強化
- **ConfigLoader統合:** defaults.jsonによる統一管理
- **永続化対応:** /var/log/pokepal/configボリュームマウント
- **プレースホルダー:** {user_name}動的置換機能
- **TaskType拡張:** REMINDERタイプ追加

### 5.3 アーキテクチャ改善
- **SharedAsyncOpenAI:** シングルトン実装でリソース効率化
- **エラーハンドリング:** 包括的な例外処理とフォールバック
- **ログ強化:** パフォーマンス測定用タイミングログ

---

## 6. 現在の課題と今後の予定

### 6.1 技術的課題と制約

#### 現在の課題
- **初回レスポンス遅延:** TTFT 5.9秒（ウォームアップ済みなのに遅い）
- **音声セグメント継続性:** 24文字ごとの個別再生で途切れる
- **Module Twin Phase2:** クラウドからの動的設定更新未実装

#### 技術的制約
- **STTストリーミング不可:** Whisper APIが非ストリーミング仕様
- **TTSセグメント問題:** Azure Speech APIの制約で連続再生困難
- **リソース制限:** Raspberry Pi 5のCPU/メモリ制約

#### 改善案
- **真のストリーミングSTT:** Azure Speech Services STTまたはWhisper.cppへの移行
- **音声バッファリング:** PyAudioやALSA直接制御で連続再生実現
- **初回改善:** DNS事前解決、より積極的なプリフェッチ

### 6.2 次期開発予定
- **9月:** Vue.js管理画面開発（統一デバイス管理）
- **10月:** ビジネス化・顧客展開（基本版3,000円モデル）
- **11月:** Jetson Orin Nano導入・マルチモーダル拡張

---

## 7. デプロイ履歴（直近）

| バージョン | 日付 | 主な変更内容 |
|-----------|------|------------|
| v0.1.76 | 8/27 | プロアクティブ機能修正完了 |
| v0.1.73-75 | 8/27 | プロアクティブ機能実装（エラー修正含む） |
| v0.1.71-72 | 8/26 | LLMウォームアップ、メモリプリロード |
| v0.1.64-70 | 8/26 | パフォーマンス最適化（キャッシング、非同期化） |
| v0.1.63 | 8/25 | コンテナ安定性修正、ユーザー名設定機能 |

---

## 8. プロジェクト管理情報

- **GitHub リポジトリ:** 
  - メイン: PokePalPoc（プライベート）
  - 公開用: Pokepal-public（ドキュメント共有用）
- **Azure DevOps:** 自動ビルド・デプロイパイプライン稼働中
- **開発環境:** MacBook Pro + VS Code + Claude Code
- **テスト環境:** Raspberry Pi 5（demo-machine-1）

---

## 9. まとめ

Pokepalプロジェクトは、8月25日から27日の3日間で大幅なパフォーマンス改善を達成した。応答時間を10秒以上から2.6～4.9秒に短縮し、コンテナの安定性問題を解決。プロアクティブ機能のConfigLoader統合により、デプロイ後の手動設定が不要になった。

現在、システムは安定稼働しており、今後は管理画面開発とビジネス展開に注力する予定である。